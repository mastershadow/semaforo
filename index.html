<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semafori Orezzo &amp; Gazzaniga</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --traffic-light-width:150px;--traffic-light-height:450px;--light-size:100px;--spacing:20px;
            --off-color:#333;--red-on:#ff0000;--orange-on:#ffa500;--green-on:#00ff00;
            --background-gradient:linear-gradient(135deg,#f0f2f5 0%,#e0e5ec 100%);
            --panel-background:#fff;--text-color:#333;
            --border-radius-large:20px;--border-radius-small:50%;
            --box-shadow-light:0 4px 8px rgba(0,0,0,.1);--box-shadow-heavy:0 8px 16px rgba(0,0,0,.2);
            --toggle-bg:#e0e0e0;--toggle-active-bg:#007bff;--toggle-text-color:#555;--toggle-active-text-color:#fff;
            --install-button-bg:#28a745;--install-button-hover-bg:#218838;--install-button-text:#fff;--install-button-border-radius:8px
        }

        /* ----- layout & tipografia principali (già presenti) ----- */
        body{font-family:'Roboto',sans-serif;display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;margin:0;background:var(--background-gradient);color:var(--text-color);overflow-x:hidden;padding:10px;box-sizing:border-box}
        #main-title{font-size:2.8em;margin-bottom:20px;color:#2c3e50;text-shadow:1px 1px 2px rgba(0,0,0,.05);text-align:center}
        #semaforo-toggle{display:flex;background-color:var(--toggle-bg);border-radius:15px;padding:5px;margin-bottom:30px;box-shadow:var(--box-shadow-light)}
        .toggle-button{padding:12px 25px;font-size:1.3em;font-weight:700;color:var(--toggle-text-color);background:transparent;border:none;border-radius:12px;cursor:pointer;transition:.3s;text-align:center;flex-grow:1}
        .toggle-button.active{background:var(--toggle-active-bg);color:var(--toggle-active-text-color);box-shadow:0 2px 8px rgba(0,0,0,.2)}
        .semaforo-display-area{display:flex;flex-direction:column;align-items:center;gap:20px}
        .traffic-light-container{width:var(--traffic-light-width);height:var(--traffic-light-height);background:#222;border-radius:var(--border-radius-large);padding:var(--spacing);display:flex;flex-direction:column;justify-content:space-around;align-items:center;box-shadow:var(--box-shadow-heavy);border:2px solid #444}
        .light{width:var(--light-size);height:var(--light-size);border-radius:var(--border-radius-small);background:var(--off-color);transition:.3s;background-color:var(--off-color);box-shadow:inset 0 0 10px rgba(0,0,0,.5);border:2px solid #555}
        .light.active.red{background:radial-gradient(circle,#ff0000 0%,#cc0000 80%);box-shadow:0 0 20px #ff0000,inset 0 0 10px rgba(255,255,255,.5)}
        .light.active.orange{background:radial-gradient(circle,#ffa500 0%,#cc8400 80%);box-shadow:0 0 20px #ffa500,inset 0 0 10px rgba(255,255,255,.5)}
        .light.active.green{background:radial-gradient(circle,#00ff00 0%,#00cc00 80%);box-shadow:0 0 20px #00ff00,inset 0 0 10px rgba(255,255,255,.5)}
        .time-display{background:var(--panel-background);border-radius:var(--border-radius-large);padding:var(--spacing);box-shadow:var(--box-shadow-light);text-align:center;width:90vw;max-width:300px;box-sizing:border-box;border:1px solid #e0e0e0}
        .time-display p{margin:8px 0;font-size:1.2em;font-weight:400}.time-display span{font-weight:700;color:#2c3e50}

        #install-button{background:var(--install-button-bg);color:var(--install-button-text);border:none;border-radius:var(--install-button-border-radius);padding:12px 25px;font-size:1.1em;font-weight:700;cursor:pointer;box-shadow:var(--box-shadow-light);transition:background-color .3s,transform .1s;margin-top:30px;margin-bottom:20px;display:none}
        #install-button:hover{background:var(--install-button-hover-bg);transform:translateY(-2px)}

        #developer-info{margin-top:20px;font-size:.9em;color:#777;text-align:center}
        #developer-info a{color:#007bff;text-decoration:none;font-weight:bold}
        #developer-info a:hover{text-decoration:underline}

        #reading-suggestion{margin-top:20px;font-size:1em;color:#555;text-align:center;font-style:italic}
        #reading-suggestion a{color:#28a745;text-decoration:none;font-weight:bold}
        #reading-suggestion a:hover{text-decoration:underline}

        /* ----- nuova CARD citazione ----- */
        .quote-card{background:#fff;border-radius:var(--border-radius-large);box-shadow:var(--box-shadow-light);padding:20px;max-width:320px;cursor:pointer;text-align:center;margin-top:35px;transition:transform .2s}
        .quote-card:hover{transform:translateY(-3px)}
        .quote-card span{font-weight:500;font-style:italic;color:#444}

        /* overlay full-screen */
        .quote-overlay{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;backdrop-filter:blur(4px);background:rgba(0,0,0,.6);z-index:2000;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
        .quote-content{background:#fff;border-radius:var(--border-radius-large);padding:30px;max-width:850px;width:100%;color:#333;position:relative;overflow-y:auto;max-height:90vh}
        .quote-content blockquote{font-size:1.25em;font-style:italic;margin:0 0 20px 0;line-height:1.4}
        #close-overlay{position:absolute;top:15px;right:20px;background:#ff5252;border:none;color:#fff;border-radius:50%;width:34px;height:34px;font-size:1.3em;font-weight:700;cursor:pointer}

        /* ----- responsivo (esistenti) ----- */
        @media (max-width:768px){
            #main-title{font-size:2.2em}
            .toggle-button{padding:10px 20px;font-size:1em}
            .traffic-light-container{width:120px;height:360px;padding:15px}
            .light{width:80px;height:80px}
            .time-display{max-width:280px}.time-display p{font-size:1.1em}
            #install-button{padding:10px 20px;font-size:1em}
        }
        @media (max-width:480px){
            #main-title{font-size:1.8em}
            .toggle-button{padding:8px 15px;font-size:.9em}
            .traffic-light-container{width:100px;height:300px;padding:10px}
            .light{width:70px;height:70px}
            .time-display{max-width:250px;padding:15px}.time-display p{font-size:1em}
            #install-button{padding:8px 15px;font-size:.9em}
        }
    </style>
</head>

<body>
    <h1 id="main-title">Controllo Semafori</h1>

    <div id="semaforo-toggle">
        <button id="show-orezzo"   class="toggle-button active">Orezzo</button>
        <button id="show-gazzaniga" class="toggle-button">Gazzaniga</button>
    </div>

    <!-- ----- Semaforo Orezzo ----- -->
    <div id="orezzo-display-area" class="semaforo-display-area">
        <div id="orezzo-light-container" class="traffic-light-container">
            <div id="orezzo-red-light"    class="light"></div>
            <div id="orezzo-orange-light" class="light"></div>
            <div id="orezzo-green-light"  class="light"></div>
        </div>
        <div class="time-display">
            <p>Ora attuale: <span id="orezzo-current-time"></span></p>
            <p>Prossimo cambio tra: <span id="orezzo-time-in-phase"></span></p>
        </div>
    </div>

    <!-- ----- Semaforo Gazzaniga ----- -->
    <div id="gazzaniga-display-area" class="semaforo-display-area" style="display:none;">
        <div id="gazzaniga-light-container" class="traffic-light-container">
            <div id="gazzaniga-red-light"    class="light"></div>
            <div id="gazzaniga-orange-light" class="light"></div>
            <div id="gazzaniga-green-light"  class="light"></div>
        </div>
        <div class="time-display">
            <p>Ora attuale: <span id="gazzaniga-current-time"></span></p>
            <p>Prossimo cambio tra: <span id="gazzaniga-time-in-phase"></span></p>
        </div>
    </div>

    <!-- ----- Scheda citazione casuale ----- -->
    <div id="random-quote-card" class="quote-card">
        <span id="quote-card-text">Scopri una citazione sul semaforo</span>
    </div>

    <!-- Overlay full-screen -->
    <div id="quote-overlay" class="quote-overlay">
        <div class="quote-content">
            <button id="close-overlay">&times;</button>
            <blockquote id="overlay-quote"></blockquote>
            <p id="overlay-context"></p>
            <p id="overlay-source" style="font-weight:700;text-align:right"></p>
        </div>
    </div>

    <button id="install-button">Installa App</button>

    <div id="reading-suggestion">
        Nell'attesa, leggi qualcosa di <a href="https://fortissimo.substack.com/" target="_blank" rel="noopener noreferrer">fortissimo</a>
        oppure ordina una pizza alla <a href="https://g.co/kgs/Q1fgVDZ" target="_blank" rel="noopener noreferrer">Penzana</a> 😉
    </div>

    <div id="developer-info">
        Un'idea di <strong>Alessandro Merelli</strong> sviluppata da <strong>Michele Merelli</strong>
    </div>

    <!-- ----- Modale installazione PWA ----- -->
    <div id="custom-install-modal" style="display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.2);padding:20px 30px;z-index:1000;text-align:center">
        <span>Installa questa app per un accesso più veloce!</span>
        <button id="custom-install-btn"   style="margin-left:20px;background:#28a745;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-weight:700;cursor:pointer">Installa</button>
        <button id="custom-install-close" style="margin-left:10px;background:transparent;color:#888;border:none;font-size:1.2em;cursor:pointer">&times;</button>
    </div>

    <script>
        /* ---------- Durate cicli semaforo ---------- */
        const greenDuration  = 31    * 1000;
        const orangeDuration = 5     * 1000;
        const redDuration    = 454.45* 1000;
        const totalCycleDuration = greenDuration + orangeDuration + redDuration;

        /* ---------- Timestamp di riferimento ---------- */
        const orezzoRefGreenTime    = new Date('2025-06-05T11:28:42+02:00').getTime();
        const gazzanigaRefGreenTime = new Date('2025-06-03T12:57:15+02:00').getTime();

        /* ---------- Elementi DOM ---------- */
        const orezzoElements = {container:document.getElementById('orezzo-display-area'),red:document.getElementById('orezzo-red-light'),orange:document.getElementById('orezzo-orange-light'),green:document.getElementById('orezzo-green-light'),currentTime:document.getElementById('orezzo-current-time'),timeInPhase:document.getElementById('orezzo-time-in-phase')};
        const gazzanigaElements = {container:document.getElementById('gazzaniga-display-area'),red:document.getElementById('gazzaniga-red-light'),orange:document.getElementById('gazzaniga-orange-light'),green:document.getElementById('gazzaniga-green-light'),currentTime:document.getElementById('gazzaniga-current-time'),timeInPhase:document.getElementById('gazzaniga-time-in-phase')};

        const orezzoToggleButton    = document.getElementById('show-orezzo');
        const gazzanigaToggleButton = document.getElementById('show-gazzaniga');
        const installButton         = document.getElementById('install-button');
        let deferredPrompt, currentSemaforo='orezzo';

        /* ---------- Orologio globale (fuso Europa/Roma) ---------- */
        let globalTimeOffset = 0; // ms rispetto a Date.now()

        async function initGlobalTime(){
            try{
                const res = await fetch('https://worldtimeapi.org/api/timezone/Europe/Rome');
                const data = await res.json();
                globalTimeOffset = new Date(data.datetime).getTime() - Date.now();
            }catch(err){
                console.error('Impossibile sincronizzare l’ora: uso l’orologio del dispositivo', err);
                globalTimeOffset = 0;
            }
        }
        const getGlobalNow = () => new Date(Date.now()+globalTimeOffset);

        /* ---------- Utility ---------- */
        const formatTimeSeconds = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;

        /* ---------- Aggiorna semaforo ---------- */
        function updateLight(el, refGreen){
            const now = getGlobalNow();
            el.currentTime.textContent = now.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false,timeZone:'Europe/Rome'});

            const elapsed = now.getTime()-refGreen;
            const timeInCycle = (elapsed%totalCycleDuration+totalCycleDuration)%totalCycleDuration;
            let remaining=0;

            el.red   .classList.remove('active','red');
            el.orange.classList.remove('active','orange');
            el.green .classList.remove('active','green');

            if(timeInCycle<greenDuration){
                el.green.classList.add('active','green');
                remaining = greenDuration - timeInCycle;
            }else if(timeInCycle<greenDuration+orangeDuration){
                el.orange.classList.add('active','orange');
                remaining = (greenDuration+orangeDuration)-timeInCycle;
            }else{
                el.red.classList.add('active','red');
                remaining = totalCycleDuration-timeInCycle;
            }
            el.timeInPhase.textContent = formatTimeSeconds(Math.max(0,Math.round(remaining/1000)));
        }

        function updateTrafficLights(){
            if(currentSemaforo==='orezzo') updateLight(orezzoElements, orezzoRefGreenTime);
            else updateLight(gazzanigaElements, gazzanigaRefGreenTime);
        }

        /* ---------- Cambio vista semaforo ---------- */
        function showSemaforo(s){
            currentSemaforo=s;
            if(s==='orezzo'){
                orezzoElements.container.style.display='flex';
                gazzanigaElements.container.style.display='none';
                orezzoToggleButton.classList.add('active');
                gazzanigaToggleButton.classList.remove('active');
            }else{
                orezzoElements.container.style.display='none';
                gazzanigaElements.container.style.display='flex';
                orezzoToggleButton.classList.remove('active');
                gazzanigaToggleButton.classList.add('active');
            }
            updateTrafficLights();
        }
        orezzoToggleButton   .addEventListener('click',()=>showSemaforo('orezzo'));
        gazzanigaToggleButton.addEventListener('click',()=>showSemaforo('gazzaniga'));

        /* ---------- Elenco citazioni ---------- */
        const quotes = [
            {quote:`«Il disco giallo si illuminò… Ormai i pedoni sono passati, ma il segnale di via libera per le macchine tarderà ancora alcuni secondi»`,source:`José Saramago, “Cecità” (1995)`,context:`Incipit: un automobilista diventa cieco mentre aspetta il verde. Le luci che cambiano annunciano il collasso dell’ordine quotidiano.`},
            {quote:`«Tutte le sue luci, ad un tratto, si tinsero di blu, e la gente non sapeva più come regolarsi.»`,source:`Gianni Rodari, “Il semaforo blu” (1962)`,context:`Favola: il semaforo blu offre un “via libera per il cielo”, invito al coraggio di immaginare.`},
            {quote:`«Il semaforo segnava giallo, giallo, giallo, continuando ad accendersi e riaccendersi.»`,source:`Italo Calvino, “Marcovaldo” (1963)`,context:`Nebbia in città: il giallo infinito diventa simbolo della monotonia urbana da cui Marcovaldo evade con la fantasia.`},
            {quote:`«Cuando vio que la mujer se lanzaba a la calzada a pesar de las luces verdes, ya era tarde…»`,source:`Julio Cortázar, “La noche boca arriba” (1956)`,context:`Incidente al semaforo: il verde diventa tragedia e spartiacque fra realtà e incubo.`},
            {quote:`«In piedi dietro al figlio, aspettando il verde, ricordò un tempo in cui aveva provato una solitudine profonda…»`,source:`Elizabeth Strout, “Olive Kitteridge” (2008)`,context:`L’attesa della luce verde è occasione di introspezione e ricordo.`},
            {quote:`«A red traffic light loomed, and Cecilia slammed her foot on the brake.»`,source:`Liane Moriarty, “The Husband’s Secret” (2013)`,context:`Il rosso obbliga Cecilia a fermarsi e a rivalutare le proprie priorità.`},
            {quote:`«Un uomo è in macchina, aspetta che scatti il verde… Il fatto è che il semaforo è verde già da un pezzo.»`,source:`Michael Frayn, “Sweet Dreams” (1973)`,context:`Satira: attesa paradossale che rivela indecisione esistenziale.`},
            {quote:`«Anche i semafori hanno un umore. Certe mattine alcuni rossi sembrano durare più a lungo.»`,source:`Fabrizio Caramagna, aforisma (2022)`,context:`Personificazione del semaforo: il rosso lungo mette alla prova la nostra pazienza.`},
            {quote:`«Il Secondo di New York è l’intervallo tra il verde e il clacson del taxi dietro di te.»`,source:`Terry Pratchett, “Streghe all’estero” (1992)`,context:`Umorismo: nelle metropoli l’attesa è ridotta al minimo.`},
            {quote:`«Fermo al semaforo in attesa di trovare un titolo, vidi passare la donna più bella…»`,source:`Andrew Faber, titolo raccolta (2018)`,context:`Il rosso diventa scintilla d’ispirazione improvvisa.`},
            {quote:`«Quando il semaforo diventa verde, il pickup non parte: è l’invito di lui a lasciare tutto…»`,source:`Robert J. Waller, “I ponti di Madison County” (1992)`,context:`Il verde sospeso segna un bivio di vita e passione.`},
            {quote:`«Greenlights mean go – advance, carry on, continue.»`,source:`Matthew McConaughey, “Greenlights” (2020)`,context:`Metafora motivazionale: cogli le “luci verdi” della vita.`},
            {quote:`«Quei semafori che a notte fonda, nelle strade deserte, alternano il verde e il rosso…»`,source:`Fabrizio Caramagna, aforisma (2022)`,context:`Il cambio luci nel vuoto diventa clessidra di tempo inutile.`},
            {quote:`«Se fossi un attimo, vorrei essere l’attimo in cui scatta il verde e la vita ricomincia.»`,source:`Fabrizio Caramagna, tweet poetico (2020 ca.)`,context:`Il verde come simbolo di ripartenza e slancio.`},
            {quote:`«Il semaforo divenne verde e Dorigo ebbe un sussulto per il clacson del solito imbecille…»`,source:`Dino Buzzati, “Un amore” (1963)`,context:`Il rosso permette al protagonista di perdersi nelle proprie gelosie; il verde lo riporta di colpo alla realtà.`},
            {quote:`«Fast asleep at the traffic light, the veterans dream of the fight…»`,source:`Jackson Browne, “The Pretender” (1976)`,context:`Semaforo come crocevia di attese: sogni dei veterani e speranze dei bambini.`},
            {quote:`«Gender is a construct, so is a traffic light, e se ignori entrambi ti investono le auto.»`,source:`Imogen Binnie, “Nevada” (2013)`,context:`Metafora pungente sul rispetto delle convenzioni sociali.`},
            {quote:`«En una esquina, ante el semáforo rojo, alguien traga fuego, alguien lava parabrisas…»`,source:`Eduardo Galeano, “Il libro degli abbracci” (1989)`,context:`Il rosso rivela la micro-economia di strada e le disuguaglianze sociali.`},
            {quote:`«È colpa del semaforo se diventa rosso quando passo io!»`,source:`Hirohiko Araki, “Le bizzarre avventure di JoJo” (1987)`,context:`Esclamazione ironica: il semaforo rosso come capro espiatorio.`},
            {quote:`«Al semaforo scatta il verde e nessuno suona più il clacson: sono tutti chinati sullo smartphone.»`,source:`Anonimo, aforisma web (2020)`,context:`La distrazione tecnologica prolunga l’attesa anche quando il verde è arrivato.`}
        ];

        /* ---------- Gestione scheda citazione ---------- */
        const card           = document.getElementById('random-quote-card');
        const cardText       = document.getElementById('quote-card-text');
        const overlay        = document.getElementById('quote-overlay');
        const overlayQuote   = document.getElementById('overlay-quote');
        const overlayContext = document.getElementById('overlay-context');
        const overlaySource  = document.getElementById('overlay-source');
        const closeBtn       = document.getElementById('close-overlay');

        const chosen = quotes[Math.floor(Math.random()*quotes.length)];
        const preview = chosen.quote.length>120 ? `${chosen.quote.slice(0,117)}…»` : chosen.quote;
        cardText.textContent = preview;

        card.addEventListener('click', ()=>{
            overlayQuote.textContent   = chosen.quote;
            overlayContext.textContent = chosen.context;
            overlaySource.textContent  = chosen.source;
            overlay.style.display='flex';
        });
        const closeOverlay = ()=> overlay.style.display='none';
        closeBtn.addEventListener('click', closeOverlay);
        overlay.addEventListener('click', e=>{ if(e.target===overlay) closeOverlay(); });

        /* ---------- PWA install ---------- */
        window.addEventListener('beforeinstallprompt',e=>{
            e.preventDefault(); deferredPrompt=e;
            installButton.style.display='block';
            document.getElementById('custom-install-modal').style.display='block';
        });
        document.getElementById('custom-install-btn').addEventListener('click',async()=>{
            document.getElementById('custom-install-modal').style.display='none';
            if(deferredPrompt){deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;}
        });
        document.getElementById('custom-install-close').addEventListener('click',()=>{document.getElementById('custom-install-modal').style.display='none'});
        window.addEventListener('appinstalled',()=>{installButton.style.display='none';console.log('PWA installata');});

        /* ---------- Service Worker ---------- */
        if('serviceWorker' in navigator){
            window.addEventListener('load',()=>{
                navigator.serviceWorker.register('/sw.js').then(reg=>console.log('SW registrato',reg)).catch(err=>console.log('SW fallito',err));
            });
        }

        /* ---------- Avvio ---------- */
        (async()=>{
            await initGlobalTime();
            showSemaforo('orezzo');
            setInterval(updateTrafficLights,100);
        })();
    </script>
</body>
</html>