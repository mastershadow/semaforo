<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semafori Italiani Sincronizzati</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colori di sfondo e testo */
            --bg-color: #1a202c; /* Blu scuro quasi nero */
            --container-bg: #2d3748; /* Blu scuro */
            --text-light: #edf2f7; /* Bianco sporco */
            --text-muted: #a0aec0; /* Grigio chiaro per dettagli */
            --header-color: #ecc94b; /* Giallo oro per titolo */
            --time-color: #63b3ed; /* Azzurro per ora */
            
            /* Colori sincronizzazione */
            --sync-success: #68d391; /* Verde brillante per successo */
            --sync-fail: #fc8181; /* Rosso tenue per errore */
            
            /* Colori semafori */
            --light-casing: #171923; /* Casing nero profondo */
            --bezel-color: #4a5568; /* Grigio scuro per la cornice */
            --light-off: #4a5568; /* Grigio scuro per luci spente */
            --red-light-on: #e53e3e; /* Rosso acceso */
            --orange-light-on: #dd6b20; /* Arancione acceso */
            --green-light-on: #48bb78; /* Verde acceso */

            /* Ombreggiature */
            --shadow-strong: rgba(0, 0, 0, 0.6);
            --shadow-subtle: rgba(0, 0, 0, 0.3);
            --inner-light-shadow: rgba(255, 255, 255, 0.4);
            --border-color: #4a5568;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-light);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        header {
            width: 100%;
            max-width: 900px;
            text-align: center;
            margin-bottom: 50px;
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            color: var(--header-color);
            margin-bottom: 15px;
            font-size: 3.2em;
            font-weight: 700;
            text-shadow: 2px 2px 5px var(--shadow-strong);
            letter-spacing: 1px;
        }

        .current-time {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--time-color);
            text-shadow: 1px 1px 3px var(--shadow-subtle);
        }

        .sync-status {
            font-size: 1em;
            color: var(--text-muted);
        }

        .semafori-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 50px; /* Spazio aumentato tra i semafori */
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 1050px; /* Larghezza massima per la griglia */
        }

        .semaforo-container {
            flex: 1 1 45%;
            min-width: 320px; /* Aumentato min-width per un aspetto più robusto */
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--container-bg);
            border-radius: 20px; /* Bordi più arrotondati */
            padding: 40px; /* Padding aumentato */
            box-shadow: 0 15px 30px var(--shadow-strong);
            transition: transform 0.4s ease-out, box-shadow 0.4s ease-out;
            border: 1px solid var(--border-color);
        }

        .semaforo-container:hover {
            transform: translateY(-12px);
            box-shadow: 0 25px 40px var(--shadow-strong);
        }

        h2 {
            font-family: 'Montserrat', sans-serif;
            color: var(--text-light);
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 700;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 15px;
            width: 100%;
            text-align: center;
            text-shadow: 1px 1px 3px var(--shadow-subtle);
        }

        .traffic-light {
            display: flex;
            flex-direction: column;
            background-color: var(--light-casing);
            border-radius: 15px; /* Bordi arrotondati per il corpo del semaforo */
            padding: 20px;
            margin-bottom: 30px;
            border: 3px solid var(--bezel-color);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.9);
        }

        .light {
            width: 100px; /* Luci più grandi */
            height: 100px;
            border-radius: 50%;
            background-color: var(--light-off);
            margin: 15px 0; /* Spazio aumentato tra le luci */
            border: 8px solid var(--bezel-color); /* Cornice più spessa */
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.9);
            transition: background-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            animation: pulseOff 2s infinite alternate ease-in-out; /* Animazione sottile per luci spente */
        }
        @keyframes pulseOff {
            from { filter: brightness(1); }
            to { filter: brightness(0.9); }
        }

        .light.red.active {
            background-color: var(--red-light-on);
            box-shadow: 0 0 40px var(--red-light-on), inset 0 0 20px var(--inner-light-shadow);
            animation: pulseOnRed 1.5s infinite alternate ease-in-out;
        }
        @keyframes pulseOnRed {
            from { transform: scale(1); filter: brightness(1); }
            to { transform: scale(1.02); filter: brightness(1.2); }
        }

        .light.orange.active {
            background-color: var(--orange-light-on);
            box-shadow: 0 0 40px var(--orange-light-on), inset 0 0 20px var(--inner-light-shadow);
            animation: pulseOnOrange 1.5s infinite alternate ease-in-out;
        }
        @keyframes pulseOnOrange {
            from { transform: scale(1); filter: brightness(1); }
            to { transform: scale(1.02); filter: brightness(1.2); }
        }

        .light.green.active {
            background-color: var(--green-light-on);
            box-shadow: 0 0 40px var(--green-light-on), inset 0 0 20px var(--inner-light-shadow);
            animation: pulseOnGreen 1.5s infinite alternate ease-in-out;
        }
        @keyframes pulseOnGreen {
            from { transform: scale(1); filter: brightness(1); }
            to { transform: scale(1.02); filter: brightness(1.2); }
        }

        .current-state {
            font-size: 3em; /* Stato ancora più grande */
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 25px;
            text-shadow: 3px 3px 6px var(--shadow-strong);
            letter-spacing: 1.5px;
        }

        .countdown {
            font-size: 1.8em; /* Conto alla rovescia più grande */
            color: var(--time-color);
            margin-bottom: 30px;
            font-weight: 700;
            text-shadow: 1px 1px 2px var(--shadow-subtle);
        }

        .cycle-info {
            font-size: 0.9em;
            color: var(--text-muted);
            text-align: center;
            padding-top: 25px; /* Spazio aumentato sopra le info */
            border-top: 1px dashed var(--border-color); /* Linea divisoria sottile */
        }

        .cycle-info p {
            margin: 8px 0; /* Spazio aumentato tra i paragrafi */
        }

        footer {
            margin-top: 60px;
            font-size: 1em;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.8;
        }

        footer a {
            color: var(--footer-link);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s ease;
            text-shadow: 0.5px 0.5px 1px var(--shadow-subtle);
        }

        footer a:hover {
            color: #90cdf4; /* Azzurro più chiaro al passaggio del mouse */
            text-decoration: underline;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2.5em;
            }
            .current-time {
                font-size: 1.5em;
            }
            .semafori-grid {
                flex-direction: column;
                gap: 30px;
            }
            .semaforo-container {
                padding: 30px;
                min-width: unset; /* Rimuovi min-width fisso */
                width: 90%; /* Occupa quasi tutta la larghezza */
            }
            h2 {
                font-size: 2em;
            }
            .light {
                width: 80px;
                height: 80px;
                margin: 10px 0;
                border: 6px solid var(--bezel-color);
            }
            .current-state {
                font-size: 2.5em;
            }
            .countdown {
                font-size: 1.4em;
            }
            .cycle-info {
                padding-top: 15px;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>Semafori Italiani Sincronizzati</h1>
        <div class="current-time" id="currentTimeDisplay">Caricamento ora...</div>
        <div class="sync-status" id="syncStatus">Sincronizzazione con WorldTimeAPI in corso...</div>
    </header>

    <div class="semafori-grid">
        <div class="semaforo-container" id="orezzoSemaforo">
            <h2>Semaforo Orezzo</h2>
            <div class="traffic-light">
                <div class="light red"></div>
                <div class="light orange"></div>
                <div class="light green"></div>
            </div>
            <div class="current-state" id="orezzoState">Caricamento...</div>
            <div class="countdown" id="orezzoCountdown"></div>
            <div class="cycle-info">
                <p>Rosso: 7 min e 35s</p>
                <p>Verde osservato: 4 Giugno, 19:24:10 CEST</p>
            </div>
        </div>

        <div class="semaforo-container" id="gazzanigaSemaforo">
            <h2>Semaforo Gazzaniga</h2>
            <div class="traffic-light">
                <div class="light red"></div>
                <div class="light orange"></div>
                <div class="light green"></div>
            </div>
            <div class="current-state" id="gazzanigaState">Caricamento...</div>
            <div class="countdown" id="gazzanigaCountdown"></div>
            <div class="cycle-info">
                <p>Rosso: 7 min e 35s</p>
                <p>Verde osservato: 3 Giugno, 12:57:15 CEST</p>
            </div>
        </div>
    </div>

    <footer>
        <p>Sviluppato da <a href="https://linktr.ee/micmer" target="_blank" rel="noopener noreferrer">micmer</a></p>
    </footer>

    <script>
        // --- Configurazione ---
        const ORANGE_TIME = 5; // secondi
        const GREEN_TIME = 31; // secondi
        const RED_TIME = 455; // secondi (7 min 35 sec)
        const TOTAL_CYCLE_TIME = GREEN_TIME + ORANGE_TIME + RED_TIME; // 491 secondi

        // Orari di verde iniziale osservati (Timestamp in millisecondi UTC)
        // Convertiamo gli orari forniti (assumendo CEST, UTC+2) in UTC per coerenza.
        const OREZ_GREEN_OBSERVED_MS = new Date('2024-06-04T19:24:10+02:00').getTime();
        const GAZZ_GREEN_OBSERVED_MS = new Date('2024-06-03T12:57:15+02:00').getTime();

        let synchronizedServerTime = null; // Memorizza l'ora attuale dal server API

        // --- Elementi DOM ---
        const currentTimeDisplay = document.getElementById('currentTimeDisplay');
        const syncStatus = document.getElementById('syncStatus');

        const orezzoSemaforoDiv = document.getElementById('orezzoSemaforo');
        const orezzoState = document.getElementById('orezzoState');
        const orezzoCountdown = document.getElementById('orezzoCountdown');
        const orezzoLights = {
            red: orezzoSemaforoDiv.querySelector('.light.red'),
            orange: orezzoSemaforoDiv.querySelector('.light.orange'),
            green: orezzoSemaforoDiv.querySelector('.light.green')
        };

        const gazzanigaSemaforoDiv = document.getElementById('gazzanigaSemaforo');
        const gazzanigaState = document.getElementById('gazzanigaState');
        const gazzanigaCountdown = document.getElementById('gazzanigaCountdown');
        const gazzanigaLights = {
            red: gazzanigaSemaforoDiv.querySelector('.light.red'),
            orange: gazzanigaSemaforoDiv.querySelector('.light.orange'),
            green: gazzanigaSemaforoDiv.querySelector('.light.green')
        };

        // --- Funzioni ---

        /**
         * Recupera l'ora precisa da WorldTimeAPI.
         */
        async function fetchSynchronizedTime() {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Europe/Rome');
                if (!response.ok) {
                    throw new Error(`Errore HTTP! status: ${response.status}`);
                }
                const data = await response.json();
                synchronizedServerTime = data.unixtime * 1000; // Converti in millisecondi
                syncStatus.textContent = 'Sincronizzato con WorldTimeAPI (CEST)';
                syncStatus.style.color = 'var(--sync-success)';
                console.log('Ora sincronizzata:', new Date(synchronizedServerTime).toLocaleString());
            } catch (error) {
                console.error('Errore durante la sincronizzazione dell\'ora:', error);
                syncStatus.textContent = 'Sincronizzazione fallita. Utilizzo ora locale (potrebbe derivare).';
                syncStatus.style.color = 'var(--sync-fail)';
                synchronizedServerTime = Date.now(); // Fallback all'ora locale
            }
        }

        /**
         * Calcola lo stato attuale e il conto alla rovescia per un dato semaforo.
         * @param {number} observedGreenMs - Timestamp (ms) del verde iniziale osservato.
         * @param {number} currentTimeMs - Ora attuale sincronizzata (ms).
         * @returns {object} { state: 'ROSSO'|'ARANCIONE'|'VERDE', timeLeft: number (secondi), nextState: 'ROSSO'|'ARANCIONE'|'VERDE' }
         */
        function getSemaforoState(observedGreenMs, currentTimeMs) {
            if (!currentTimeMs) {
                return { state: 'SCONOSCIUTO', timeLeft: 0, nextState: 'SCONOSCIUTO' };
            }

            const totalElapsedSeconds = Math.floor((currentTimeMs - observedGreenMs) / 1000);

            let timeInCurrentCycle = totalElapsedSeconds % TOTAL_CYCLE_TIME;
            if (timeInCurrentCycle < 0) {
                timeInCurrentCycle += TOTAL_CYCLE_TIME;
            }

            let state, timeLeft, nextState;

            if (timeInCurrentCycle < GREEN_TIME) {
                state = 'VERDE';
                timeLeft = GREEN_TIME - timeInCurrentCycle;
                nextState = 'ARANCIONE';
            } else if (timeInCurrentCycle < (GREEN_TIME + ORANGE_TIME)) {
                state = 'ARANCIONE';
                timeLeft = (GREEN_TIME + ORANGE_TIME) - timeInCurrentCycle;
                nextState = 'ROSSO';
            } else { // Nella fase ROSSO
                state = 'ROSSO';
                timeLeft = TOTAL_CYCLE_TIME - timeInCurrentCycle;
                nextState = 'VERDE';
            }

            return { state, timeLeft, nextState };
        }

        /**
         * Aggiorna l'interfaccia utente per un singolo semaforo.
         * @param {HTMLElement} stateElement - Elemento DOM per il testo dello stato attuale.
         * @param {HTMLElement} countdownElement - Elemento DOM per il testo del conto alla rovescia.
         * @param {object} lightElements - Oggetto con gli elementi DOM delle luci rossa, arancione, verde.
         * @param {object} semaforoData - Risultato da getSemaforoState.
         */
        function updateSemaforoUI(stateElement, countdownElement, lightElements, semaforoData) {
            stateElement.textContent = semaforoData.state;
            countdownElement.textContent = `Prossimo cambio in: ${semaforoData.timeLeft} secondi (a ${semaforoData.nextState})`;

            Object.values(lightElements).forEach(light => {
                light.classList.remove('active');
                light.style.animation = 'pulseOff 2s infinite alternate ease-in-out'; /* Reset animazione OFF */
            });
            stateElement.style.color = 'var(--text-light)';

            if (semaforoData.state === 'ROSSO') {
                lightElements.red.classList.add('active');
                stateElement.style.color = 'var(--red-light-on)';
                lightElements.red.style.animation = 'pulseOnRed 1.5s infinite alternate ease-in-out';
            } else if (semaforoData.state === 'ARANCIONE') {
                lightElements.orange.classList.add('active');
                stateElement.style.color = 'var(--orange-light-on)';
                lightElements.orange.style.animation = 'pulseOnOrange 1.5s infinite alternate ease-in-out';
            } else if (semaforoData.state === 'VERDE') {
                lightElements.green.classList.add('active');
                stateElement.style.color = 'var(--green-light-on)';
                lightElements.green.style.animation = 'pulseOnGreen 1.5s infinite alternate ease-in-out';
            }
        }

        /**
         * Ciclo di aggiornamento principale.
         */
        function updateAllSemafori() {
            if (synchronizedServerTime !== null) {
                synchronizedServerTime += 1000;

                const dateOptions = {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false,
                    timeZoneName: 'short'
                };
                currentTimeDisplay.textContent = new Date(synchronizedServerTime).toLocaleString('it-IT', dateOptions);

                const orezzoData = getSemaforoState(OREZ_GREEN_OBSERVED_MS, synchronizedServerTime);
                updateSemaforoUI(orezzoState, orezzoCountdown, orezzoLights, orezzoData);

                const gazzanigaData = getSemaforoState(GAZZ_GREEN_OBSERVED_MS, synchronizedServerTime);
                updateSemaforoUI(gazzanigaState, gazzanigaCountdown, gazzanigaLights, gazzanigaData);
            }
        }

        // --- Inizializzazione ---

        fetchSynchronizedTime();

        setInterval(fetchSynchronizedTime, 5 * 60 * 1000);

        setInterval(updateAllSemafori, 1000);

    </script>

</body>
</html>
